[TOC]

# Mark - 深入理解网络通信和TCP/IP协议

## 计算机网络体系结构

### OSI七层模型

- OSI 采用分层的结构化技术，共分七层：
  1. 物理层
  2. 数据链路层
  3. 网络层
  4. 传输层
  5. 会话层
  6. 表示层
  7. 应用层

![](https://note.youdao.com/yws/public/resource/7d82cceeb1c16a97418e2021bea050dd/xmlnote/OFFICEB790B77E0B9F44C190122B400AFFC256/9953)

## TCP/IP模型

- 由于 OSI 模型比较复杂且学术化，所以实际使用的是 TCP/IP 模型，分五层：
  1. 物理层
  2. 数据链路层（也有 TCP/IP 模型将 物理层、数据链路层 合称为 网络接口层，与之对应的协议就被称为 TCP/IP 四层协议模型）
  3. 网络层
  4. 传输层
  5. 应用层
- 两个模型之间的对应关系如下图：

![](https://note.youdao.com/yws/public/resource/7d82cceeb1c16a97418e2021bea050dd/xmlnote/OFFICED2F6E3E96B59477780B59EBF60DBF078/9954)

### TCP/IP 协议族

- 很多情况下， 它是利用 IP 进行通信时必须用到的协议群的统称。也就是说，它其实是个协议家族，由很多个协议组成，并在不同的层。是物联网的基础通信架构

![](https://note.youdao.com/yws/public/resource/7d82cceeb1c16a97418e2021bea050dd/xmlnote/OFFICE749320D3987F42FEBCDC09D829F66B13/9955)

## IP、TCP和UDP

- 上述图形中，网际协议 IP 是 TCP/IP 中非常重要的协议，往往用来确定网络中唯一的一台计算设备。
  - 所以这层负责对数据加上 IP 地址（源地址和目标地址）和其他数据，用于确定传输的目标
- 而 TCP 和 UDP 都是传输层的协议，主要为两台主机上的应用程序提供 端到端 的通信。

### TCP

- 提供了一种可靠的数据传输服务，TCP是面向连接的
- 即：利用 TCP 通信的两台主机首先要经历一个 建立连接 的过程，等到连接建立后才开始传输数据
- 而且传输过程中采用 "带重传的肯定确认" 技术来实现传输的可靠性
- TCP 还采用一种称为 "滑动窗口" 的方式进行流量控制，发送完成后还会关闭连接

### UDP

- 直接把数据发出去，不管对方接收的情况，属于不可靠的传输
- 可能会出现丢包现象，实际应用中要求程序员编码验证



**注意**

- 常见的网络应用基本上都是基于 TCP 和 UDP 的，这俩协议又会使用网络层的 IP 协议。
- 但我们完全可以绕过传输层的 TCP 和 UDP，直接使用 IP，比如 Linux 内核中的 LVS 就可以直接基于 IP 层进行负载均衡调度
- 甚至还可以直接访问链路层，比如 tcpdump 程序就是直接和链路层进行通信的

## TCP/IP 网络传输中的数据

- 每个分层中，都会对所发送的数据附加一个首部，在这个首部中包含了该层必要的信息
  - 如：发送的目标地址以及协议相关信息。
- 通常，为协议提供的信息为包首部，所要发送的内容为数据。
  - 在下一层的角度看，从上一层收到的包全部都被认为是本层的数据。



- 网络中传输的数据包由两部分组成：
  1. 协议所要用到的首部
  2. 上一层传过来的数据
- 首部的结构由协议的具体规范详细定义。
  - 在数据包的首部，明确标明了协议应该如何读取数据。
- 以用户A发送、用户B接受来举例：
  1. A 应用程序处理
     - 首先应用程序会进行编码处理，产生报文/消息(message) 交给下面的 TCP 层
  2. A TCP模块处理
     - 