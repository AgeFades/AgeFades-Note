[TOC]

# 楼兰 - RocketMQ生产常见问题分析与总结

## 一、RocketMQ如何保证消息不丢失

### 1. 哪些环节会有丢消息的可能性

下面是一个通用的MQ场景：

![](https://note.youdao.com/yws/public/resource/c57d928530353185def257b19b410862/WEBRESOURCEcd78fbeca3a4e2f9b71918a7896eb0bb?ynotemdtimestamp=1716943499478)

1、2、4这三个场景是跨网络的，跨网络就存在丢消息的可能

3的场景，通常是MQ存盘时都会先写入操作系统的缓存`page cache`中，然后再由操作系统异步刷盘。

- 这中间存在时间差，就可能造成消息丢失。（服务挂了，缓存中还没写入磁盘的消息就丢失了）

### 2. RocketMQ消息0丢失方案

#### 1. producer使用事务消息机制保证消息0丢失

以最常见的电商订单场景为例，来简单分析事物机制如何保证消息0丢失

![](https://note.youdao.com/yws/public/resource/c57d928530353185def257b19b410862/WEBRESOURCE315305bdfb24317933d5ba63667ca885?ynotemdtimestamp=1716943499478)

##### 1. half消息的作用

在下单前发送，对下游consumer不可见。该消息作用为：`确认RocketMQ的服务是否正常`

##### 2. half消息写入失败怎么办？

没有half消息流程，通常就会在订单系统中先完成下单，再发消息给MQ

此时写入消息到MQ如果失败，就尴尬了。

而half消息写入失败的话，即可认为MQ服务有问题，此时就不能通知下游了。

可以在下单时给订单一个状态标记，然后等待MQ服务正常后再进行补偿操作、重新下单通知下游服务

##### 3. 订单系统写DB失败了怎么办？

写db失败（可能数据库临时挂了），可以另外找个地方把订单消息先缓存起来（Redis...）给RocketMQ响应 unknow

RocketMQ过段时间来回查事务状态，再尝试重新写DB，此时DB恢复，就可以走完成的下单流程。

##### 4. half消息写入成功后，MQ挂了怎么办？

事务消息的处理机制中，unknow的事务状态回查是由broker主动发起的。

如果出现这种情况，MQ就不会回调服务，此时，将订单一直标记为 `new` 状态，

等MQ恢复后，只要存储的消息没丢失，即可继续状态回查的流程

##### 5. 下单成功后如何优雅等待支付成功？

可以用事务消息的状态回查机制来代替定时任务。

下单时，给Broker返回unknow，状态回查的方法中去查询订单的支付状态。

仅需配置RocketMQ中的事务消息回查次数（默认15次）和事务回查间隔时间（messageDelayLevel）

##### 6. 事务消息机制的作用

在上面举例场景下，消息不丢失的问题实际转化成了分布式事务一致性问题。

RocketMQ的事务消息机制，仅完成了整个事务消息的一半，保证下单和发消息的一致性，对下游事务没保证。

目前来看，这也是业内最好的分布式事务降级方案。

#### 2. RocketMQ配置同步刷盘+Dledger主从架构保证MQ主从同步时不丢消息

##### 1. 同步刷盘

简单把RocketMQ的刷盘方式 `flushDiskType` 配置成同步刷盘即可保证。

##### 2. Dledger的文件同步

![](https://note.youdao.com/yws/public/resource/c57d928530353185def257b19b410862/WEBRESOURCE0a299ec12bd638fd39704b527d441339?ynotemdtimestamp=1716943499478)

Dledger会通过`两阶段提交`的方式保证文件在主从之间成功同步。

Dledger主要作用：

- Broker自动选主
- 接管Brocker的CommitLog文件写入过程。将单机的文件写入，转为基于多数同意机制的分布式消息写入。

